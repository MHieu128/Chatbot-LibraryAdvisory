{% extends "base.html" %}

{% block title %}Chat - Library Advisory System{% endblock %}

{% block sidebar %}
<div class="mt-4">
    <h6 class="text-muted mb-3">Available Libraries</h6>
    <div class="list-group">
        {% for library in libraries %}
        <div class="list-group-item list-group-item-action library-card" 
             onclick="analyzeLibrary('{{ library.name }}')">
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">{{ library.name }}</h6>
                <small class="text-muted">{{ library.language }}</small>
            </div>
            <p class="mb-1">{{ library.description }}</p>
            <small class="text-muted">{{ library.category }}</small>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-comments text-primary"></i> Chat with Library Advisor</h2>
                <div>
                    <button class="btn btn-outline-danger btn-sm" onclick="clearConversation()">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="saveConversation()">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
            </div>
            
            <!-- Chat Container -->
            <div id="chatContainer" class="chat-container mb-3">
                {% if conversation_history %}
                    {% for message in conversation_history %}
                    <div class="message user-message">
                        <strong>You:</strong> {{ message.user }}
                        <div class="timestamp">{{ message.timestamp }}</div>
                    </div>
                    <div class="message bot-message">
                        <div class="response-content">{{ message.bot|safe }}</div>
                        <div class="timestamp">{{ message.timestamp }}</div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="text-center text-muted p-4">
                    <i class="fas fa-robot fa-3x mb-3"></i>
                    <h5>Welcome to Library Advisory System!</h5>
                    <p>Start by asking about a library, comparing frameworks, or requesting recommendations.</p>
                    <div class="mt-3">
                        <small class="text-muted">
                            Try: "analyze React", "compare Vue vs Angular", or "recommend Python frameworks"
                        </small>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Input Area -->
            <div class="input-group">
                <input type="text" id="messageInput" class="form-control" 
                       placeholder="Ask about libraries, compare frameworks, or get recommendations..." 
                       onkeypress="handleKeyPress(event)">
                <button class="btn btn-primary" type="button" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i> Send
                </button>
            </div>
            
            <!-- Quick Commands -->
            <div class="mt-3">
                <div class="row">
                    <div class="col-md-3">
                        <button class="btn btn-outline-secondary btn-sm w-100" onclick="insertCommand('analyze ')">
                            <i class="fas fa-search"></i> Analyze Library
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-secondary btn-sm w-100" onclick="insertCommand('compare ')">
                            <i class="fas fa-balance-scale"></i> Compare
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-secondary btn-sm w-100" onclick="insertCommand('recommend ')">
                            <i class="fas fa-lightbulb"></i> Recommend
                        </button>
                    </div>
                    {% if ai_enabled %}
                    <div class="col-md-3">
                        <button class="btn btn-outline-secondary btn-sm w-100" onclick="insertCommand('ai ')">
                            <i class="fas fa-robot"></i> Ask AI
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="mt-2">Processing your request...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

function insertCommand(command) {
    const input = document.getElementById('messageInput');
    input.value = command;
    input.focus();
}

function analyzeLibrary(libraryName) {
    const input = document.getElementById('messageInput');
    input.value = `analyze ${libraryName}`;
    sendMessage();
}

function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Clear input immediately
    input.value = '';
    
    // Add user message to chat
    addMessage(message, 'user');
    
    // Show loading modal
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();
    
    // Send to server
    fetch('/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        loadingModal.hide();
        if (data.error) {
            addMessage('Error: ' + data.error, 'bot');
        } else {
            addMessage(data.response, 'bot', data.timestamp);
        }
    })
    .catch(error => {
        loadingModal.hide();
        addMessage('Error: Failed to send message', 'bot');
        console.error('Error:', error);
    });
}

function addMessage(content, type, timestamp) {
    const chatContainer = document.getElementById('chatContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    
    const now = timestamp || new Date().toLocaleTimeString();
    
    if (type === 'user') {
        messageDiv.innerHTML = `
            <strong>You:</strong> ${escapeHtml(content)}
            <div class="timestamp">${now}</div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="response-content">${content}</div>
            <div class="timestamp">${now}</div>
        `;
    }
    
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function clearConversation() {
    if (confirm('Are you sure you want to clear the conversation?')) {
        fetch('/clear_conversation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('chatContainer').innerHTML = `
                    <div class="text-center text-muted p-4">
                        <i class="fas fa-robot fa-3x mb-3"></i>
                        <h5>Welcome to Library Advisory System!</h5>
                        <p>Start by asking about a library, comparing frameworks, or requesting recommendations.</p>
                        <div class="mt-3">
                            <small class="text-muted">
                                Try: "analyze React", "compare Vue vs Angular", or "recommend Python frameworks"
                            </small>
                        </div>
                    </div>
                `;
            }
        })
        .catch(error => {
            alert('Error clearing conversation');
            console.error('Error:', error);
        });
    }
}

function saveConversation() {
    fetch('/save_conversation', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Conversation saved successfully to: ${data.filepath}`);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error saving conversation');
        console.error('Error:', error);
    });
}

// Auto-focus on input when page loads
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('messageInput').focus();
});
</script>
{% endblock %}
