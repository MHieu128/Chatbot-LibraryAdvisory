{% extends "base.html" %}

{% block title %}Chat - Library Advisory System{% endblock %}

{% block sidebar %}
<div class="mt-4">
    <h6 class="text-muted mb-3">Available Libraries</h6>
    <div class="list-group">
        {% for library in libraries %}
        <div class="list-group-item list-group-item-action library-card" 
             onclick="analyzeLibrary('{{ library.name }}')">
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">{{ library.name }}</h6>
                <small class="text-muted">{{ library.language }}</small>
            </div>
            <p class="mb-1">{{ library.description }}</p>
            <small class="text-muted">{{ library.category }}</small>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-comments text-primary"></i> Chat with Library Advisor</h2>
                <div class="d-flex align-items-center gap-2">
                    <!-- Audio Controls -->
                    <div class="btn-group" role="group">
                        <input type="checkbox" class="btn-check" id="autoTtsToggle" autocomplete="off">
                        <label class="btn btn-outline-info btn-sm" for="autoTtsToggle" title="Auto-play responses with TTS">
                            <i class="fas fa-volume-up"></i> TTS
                        </label>
                    </div>
                    
                    <button class="btn btn-outline-danger btn-sm" onclick="clearConversation()">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="saveConversation()">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
            </div>
            
            <!-- Chat Container -->
            <div id="chatContainer" class="chat-container mb-3">
                {% if conversation_history %}
                    {% for message in conversation_history %}
                    <div class="message user-message">
                        <strong>You:</strong> {{ message.user }}
                        <div class="timestamp">{{ message.timestamp }}</div>
                    </div>
                    <div class="message bot-message">
                        <div class="response-content">{{ message.bot|safe }}</div>
                        <div class="timestamp">{{ message.timestamp }}</div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="text-center text-muted p-4">
                    <i class="fas fa-robot fa-3x mb-3"></i>
                    <h5>Welcome to Library Advisory System!</h5>
                    <p>Start by asking about a library, comparing frameworks, or requesting recommendations.</p>
                    <div class="mt-3">
                        <small class="text-muted">
                            Try: "analyze React", "compare Vue vs Angular", or "recommend Python frameworks"
                        </small>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Input Area -->
            <div class="input-group">
                <textarea id="messageInput" class="form-control chat-input" rows="1"
                       placeholder="Ask about libraries, compare frameworks, or get recommendations..." 
                       onkeypress="handleKeyPress(event)"></textarea>
                <button class="btn btn-primary" type="button" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i> Send
                </button>
            </div>
            
            <!-- Quick Commands -->
            <div class="mt-3">
                <div class="row">
                    <div class="col-md-3">
                        <button class="btn btn-outline-secondary btn-sm w-100" onclick="insertCommand('analyze ')">
                            <i class="fas fa-search"></i> Analyze Library
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-secondary btn-sm w-100" onclick="insertCommand('compare ')">
                            <i class="fas fa-balance-scale"></i> Compare
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-secondary btn-sm w-100" onclick="insertCommand('recommend ')">
                            <i class="fas fa-lightbulb"></i> Recommend
                        </button>
                    </div>
                    {% if ai_enabled %}
                    <div class="col-md-3">
                        <button class="btn btn-outline-secondary btn-sm w-100" onclick="insertCommand('ai ')">
                            <i class="fas fa-robot"></i> Ask AI
                        </button>
                    </div>
                    {% endif %}
                </div>
                
                <!-- TTS Status and Controls -->
                <div class="mt-3 p-3 bg-light rounded tts-status-panel">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-volume-up text-info me-2"></i>
                                <span class="fw-bold">Text-to-Speech</span>
                                <span id="ttsStatusBadge" class="badge bg-secondary ms-2">Checking...</span>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <button id="testTtsBtn" class="btn btn-outline-info btn-sm" onclick="testTTS()" disabled>
                                <i class="fas fa-play"></i> Test TTS
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="mt-2">Processing your request...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

function insertCommand(command) {
    const input = document.getElementById('messageInput');
    input.value = command;
    input.focus();
}

function analyzeLibrary(libraryName) {
    const input = document.getElementById('messageInput');
    input.value = `analyze ${libraryName}`;
    sendMessage();
}

function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Clear input immediately
    input.value = '';
    
    // Add user message to chat
    addMessage(message, 'user');
    
    // Show loading modal
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();
    
    // Send to server with TTS preference
    const enableTts = document.getElementById('autoTtsToggle').checked;
    fetch('/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: message,
            enable_tts: enableTts
        })
    })
    .then(response => response.json())
    .then(data => {
        loadingModal.hide();
        if (data.error) {
            addMessage('Error: ' + data.error, 'bot');
        } else {
            addMessage(data.response, 'bot', data.timestamp, data);
        }
    })
    .catch(error => {
        loadingModal.hide();
        addMessage('Error: Failed to send message', 'bot');
        console.error('Error:', error);
    });
}

function addMessage(content, type, timestamp, responseData) {
    const chatContainer = document.getElementById('chatContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    
    const now = timestamp || new Date().toLocaleTimeString();
    
    if (type === 'user') {
        messageDiv.innerHTML = `
            <strong>You:</strong> ${escapeHtml(content)}
            <div class="timestamp">${now}</div>
        `;
    } else {
        let audioControls = '';
        
        // Add audio controls if available
        if (responseData && responseData.has_audio) {
            const cacheIcon = responseData.audio_cache_hit ?
                '<i class="fas fa-bolt text-warning" title="Cached audio"></i>' :
                '<i class="fas fa-microphone text-success" title="Generated audio"></i>';
            
            audioControls = `
                <div class="audio-controls mt-2 p-2 bg-light rounded">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            ${cacheIcon}
                            <audio controls class="ms-2" style="height: 32px;">
                                <source src="${responseData.audio_url}" type="audio/wav">
                                Your browser does not support audio playback.
                            </audio>
                        </div>
                        <small class="text-muted">
                            ${responseData.audio_duration ? Math.round(responseData.audio_duration) + 's' : ''}
                        </small>
                    </div>
                </div>
            `;
        }
        
        // Add enhanced indicator if applicable
        const enhancedBadge = (responseData && responseData.enhanced) ?
            '<span class="badge bg-info ms-2" title="Enhanced with semantic search"><i class="fas fa-search"></i> Enhanced</span>' : '';
        
        messageDiv.innerHTML = `
            <div class="response-header d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <strong>Assistant:</strong>
                    ${enhancedBadge}
                </div>
                <div class="timestamp">${now}</div>
            </div>
            <div class="response-content">${content}</div>
            ${audioControls}
        `;
    }
    
    chatContainer.appendChild(messageDiv);
    
    // Auto-play audio if enabled and available
    if (responseData && responseData.has_audio && document.getElementById('autoTtsToggle').checked) {
        setTimeout(() => {
            const audio = messageDiv.querySelector('audio');
            if (audio) {
                audio.play().catch(e => console.log('Auto-play prevented by browser:', e));
            }
        }, 500);
    }
    
    // Smooth scroll to bottom
    setTimeout(() => {
        chatContainer.scrollTo({
            top: chatContainer.scrollHeight,
            behavior: 'smooth'
        });
    }, 100);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function clearConversation() {
    if (confirm('Are you sure you want to clear the conversation?')) {
        fetch('/clear_conversation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('chatContainer').innerHTML = `
                    <div class="text-center text-muted p-4">
                        <i class="fas fa-robot fa-3x mb-3"></i>
                        <h5>Welcome to Library Advisory System!</h5>
                        <p>Start by asking about a library, comparing frameworks, or requesting recommendations.</p>
                        <div class="mt-3">
                            <small class="text-muted">
                                Try: "analyze React", "compare Vue vs Angular", or "recommend Python frameworks"
                            </small>
                        </div>
                    </div>
                `;
            }
        })
        .catch(error => {
            alert('Error clearing conversation');
            console.error('Error:', error);
        });
    }
}

function saveConversation() {
    fetch('/save_conversation', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Conversation saved successfully to: ${data.filepath}`);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error saving conversation');
        console.error('Error:', error);
    });
}

// Auto-focus on input when page loads
document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('messageInput');
    input.focus();
    
    // Scroll to bottom of chat on page load
    const chatContainer = document.getElementById('chatContainer');
    if (chatContainer) {
        setTimeout(() => {
            chatContainer.scrollTo({
                top: chatContainer.scrollHeight,
                behavior: 'smooth'
            });
        }, 300);
    }
    
    // Auto-resize textarea
    input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
    
    // Reset height when message is sent
    const originalSendMessage = sendMessage;
    sendMessage = function() {
        originalSendMessage();
        input.style.height = 'auto';
    };
    
    // Check TTS status on page load
    checkTTSStatus();
});

// TTS Functions
function checkTTSStatus() {
    fetch('/api/tts/status')
        .then(response => response.json())
        .then(data => {
            const statusBadge = document.getElementById('ttsStatusBadge');
            const testBtn = document.getElementById('testTtsBtn');
            
            if (data.available) {
                statusBadge.textContent = 'Ready';
                statusBadge.className = 'badge bg-success ms-2';
                testBtn.disabled = false;
            } else {
                statusBadge.textContent = 'Unavailable';
                statusBadge.className = 'badge bg-danger ms-2';
                testBtn.disabled = true;
            }
        })
        .catch(error => {
            console.error('TTS status check failed:', error);
            const statusBadge = document.getElementById('ttsStatusBadge');
            statusBadge.textContent = 'Error';
            statusBadge.className = 'badge bg-warning ms-2';
        });
}

function testTTS() {
    const testText = "Hello! This is a test of the text-to-speech system. Library Advisory System is ready to help you with audio responses.";
    
    fetch('/api/tts/generate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            text: testText,
            use_cache: false
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Create temporary audio element and play
            const audio = new Audio(data.audio_url);
            audio.play().catch(e => {
                alert('Could not play audio. Please check your browser settings.');
                console.error('Audio play failed:', e);
            });
            
            // Show success message
            const testBtn = document.getElementById('testTtsBtn');
            const originalText = testBtn.innerHTML;
            testBtn.innerHTML = '<i class="fas fa-check text-success"></i> Playing...';
            testBtn.disabled = true;
            
            audio.onended = () => {
                testBtn.innerHTML = originalText;
                testBtn.disabled = false;
            };
        } else {
            alert('TTS test failed: ' + data.error);
        }
    })
    .catch(error => {
        alert('TTS test failed: ' + error.message);
        console.error('TTS test error:', error);
    });
}

// Generate TTS for any text
function generateTTSForText(text, callback) {
    fetch('/api/tts/generate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ text: text })
    })
    .then(response => response.json())
    .then(data => {
        if (callback) callback(data);
    })
    .catch(error => {
        console.error('TTS generation failed:', error);
        if (callback) callback({ success: false, error: error.message });
    });
}
</script>
{% endblock %}
